{"id":124,"date":"2019-08-09T10:51:50","date_gmt":"2019-08-09T10:51:50","guid":{"rendered":"https:\/\/golangbyexamples.com\/?p=124"},"modified":"2019-11-12T20:06:32","modified_gmt":"2019-11-12T20:06:32","slug":"go-new-relic-example-in-golang-with-deep-instrumentation","status":"publish","type":"post","link":"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/","title":{"rendered":"New Relic Example in GoLang with Deep Instrumentation"},"content":{"rendered":"\n<p class=\"has-medium-font-size\">It is easy to integrate newrelic in GoLang. We just need one of the middleware to use the newrelic. Application. For eg in GIN framework of GO we can do something like this <\/p>\n\n\n\n<pre class=\"wp-block-prismatic-blocks\"><code class=\"language-go\">nrConfig := newrelic.NewConfig(\"test\", \"somekey\")\nnrapp, err = newrelic.NewApplication(nrConfig)\nr := gin.Default()\nr.Use(nrgin.Middleware(nrapp))<\/code><\/pre>\n\n\n\n<p>With this change, you will able to see your application in new relic something like this <\/p>\n\n\n\n<figure class=\"wp-block-image\"><img loading=\"lazy\" decoding=\"async\" width=\"2090\" height=\"1162\" src=\"https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?fit=980%2C545&amp;ssl=1\" alt=\"\" class=\"wp-image-134\" srcset=\"https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?w=2090&amp;ssl=1 2090w, https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?resize=300%2C167&amp;ssl=1 300w, https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?resize=768%2C427&amp;ssl=1 768w, https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?resize=1024%2C569&amp;ssl=1 1024w, https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?w=1280&amp;ssl=1 1280w, https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?w=1920&amp;ssl=1 1920w\" sizes=\"auto, (max-width: 640px) 100vw, 640px\" \/><\/figure>\n\n\n\n<p class=\"has-medium-font-size\">But you will not be able to see the breakdown of api in &#8220;Transaction&#8221; because  Go is a compiled language. Hence unlike JAVA to see the breakup of the API you have to do explicit deep instrumentation in golang. Below is a simple example of how to use newrelic in the GIN web framework of go with deep instrumentation and using context.<\/p>\n\n\n\n<p class=\"has-medium-font-size\"><strong>main.go<\/strong><\/p>\n\n\n\n<pre class=\"wp-block-prismatic-blocks\"><code class=\"language-go\">package main\n\nimport (\n\t\"context\"\n\t\"net\/http\"\n\t\"time\"\n\n\t\"github.com\/gin-gonic\/gin\"\n\tnr \"github.com\/newrelic\/go-agent\"\n\t\"github.com\/newrelic\/go-agent\/_integrations\/nrgin\/v1\"\n)\n\ntype key int\n\nconst (\n   keyNrID key = iota\n)\n\nvar (\n    nrapp newrelic.Application\n)\n\nfunc main() {\n\tinitNewRelic()\n\tr := gin.Default()\n\tr.Use(nrgin.Middleware(nrapp))\n\tr.Use(setNewRelicInContext())\n\n\tsetUpRoutes(r)\n\t\/\/ Listen and Server in 0.0.0.0:8080\n\ts := &http.Server{\n\t\tAddr:         \":8080\",\n\t\tHandler:      r,\n\t}\n\ts.ListenAndServe()\n}\n\n\/\/populateNewRelicInContext get the request context populated\nfunc setNewRelicInContext() gin.HandlerFunc {\n\n\treturn func(c *gin.Context) {\n\t\t\/\/Setup context\n\t\tctx := c.Request.Context()\n\n\t\t\/\/Set newrelic context\n\t\tvar txn nr.Transaction\n\t\t\/\/newRelicTransaction is the key populated by nrgin Middleware\n\t\tvalue, exists := c.Get(\"newRelicTransaction\")\n\t\tif exists {\n\t\t\tif v, ok := value.(nr.Transaction); ok {\n\t\t\t\ttxn = v\n\t\t\t}\n\t\t\tctx = context.WithValue(ctx, keyNrID, txn)\n\t\t}\n\t\tc.Request = c.Request.WithContext(ctx)\n\t\tc.Next()\n\t}\n}\n\n\nfunc initNewRelic() {\n\tvar err error\n\tnrConfig := newrelic.NewConfig(\"test\", \"somekey\")\n\tnrapp, err = newrelic.NewApplication(nrConfig)\n\tif err != nil {\n\t\tpanic(\"Failed to setup NewRelic: \" + err.Error())\n\t}\n}\n<\/code><\/pre>\n\n\n\n<p class=\"has-medium-font-size\"><strong>routes.go<\/strong><\/p>\n\n\n\n<pre class=\"wp-block-prismatic-blocks\"><code class=\"language-go\">package main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"net\/http\"\n\t\"time\"\n\t\"github.com\/gin-gonic\/gin\"\n\tnr \"github.com\/newrelic\/go-agent\"\n)\n\n\/\/setUpRoutes set all the routes\nfunc setUpRoutes(r *gin.Engine) {\n\tr.GET(\"\/app\/status\", getStatus)\n}\n\nfunc getStatus(c *gin.Context) {\n\tctx := c.Request.Context()\n\terr := callGoogle(ctx)\n\tif err != nil {\n\t\tc.Writer.WriteHeader(400)\n\t\treturn\n\t}\n\tdoSomeThing(ctx)\n\tc.Writer.WriteHeader(200)\n}\n\nfunc callGoogle(ctx context.Context) error {\n\tif t := ctx.Value(keyNrID); t != nil {\n\t\ttxn := t.(nr.Transaction)\n\t\tdefer nr.StartSegment(txn, \"callGoogle\").End()\n\t}\n\tresp, err := http.Get(\"http:\/\/google.com\/\")\n\tif err != nil {\n\t\treturn fmt.Errorf(\"Some error occuerd %s\", err.Error())\n\t}\n\tdefer resp.Body.Close()\n\treturn nil\n}\n\nfunc doSomeThing(ctx context.Context) {\n\tif t := ctx.Value(keyNrID); t != nil {\n\t\ttxn := t.(nr.Transaction)\n\t\tdefer nr.StartSegment(txn, \"doSomeThing\").End()\n\t}\n\ttime.Sleep(time.Millisecond * 100)\n}<\/code><\/pre>\n\n\n\n<p class=\"has-medium-font-size\">This is how the breakdown is visible in NewRelic. See it is showing how much average time is spent in &#8220;callGoogle&#8221; and &#8220;doSomeThing&#8221; function.<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img loading=\"lazy\" decoding=\"async\" width=\"1614\" height=\"1300\" src=\"https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.39.16-PM.png?fit=980%2C790&amp;ssl=1\" alt=\"\" class=\"wp-image-131\" srcset=\"https:\/\/i2.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.39.16-PM.png?w=1614&amp;ssl=1 1614w, https:\/\/i2.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.39.16-PM.png?resize=300%2C242&amp;ssl=1 300w, https:\/\/i2.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.39.16-PM.png?resize=768%2C619&amp;ssl=1 768w, https:\/\/i2.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.39.16-PM.png?resize=1024%2C825&amp;ssl=1 1024w, https:\/\/i2.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.39.16-PM.png?w=1280&amp;ssl=1 1280w\" sizes=\"auto, (max-width: 640px) 100vw, 640px\" \/><\/figure>\n\n\n\n<p><\/p>\n","protected":false},"excerpt":{"rendered":"<p>It is easy to integrate newrelic in GoLang. We just need one of the middleware to use the newrelic. Application. For eg in GIN framework of GO we can do something like&#8230;<\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"spay_email":"","footnotes":"","jetpack_publicize_message":"","jetpack_is_tweetstorm":false},"categories":[1],"tags":[6,3,4,7,5],"class_list":["post-124","post","type-post","status-publish","format-standard","hentry","category-tech","tag-context","tag-go","tag-golang","tag-intrumentation","tag-newrelic"],"yoast_head":"<!-- This site is optimized with the Yoast SEO plugin v22.7 - https:\/\/yoast.com\/wordpress\/plugins\/seo\/ -->\n<title>New Relic Example in GoLang with Deep Instrumentation - Welcome To Golang By Example<\/title>\n<meta name=\"robots\" content=\"index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1\" \/>\n<link rel=\"canonical\" href=\"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/\" \/>\n<meta property=\"og:locale\" content=\"en_US\" \/>\n<meta property=\"og:type\" content=\"article\" \/>\n<meta property=\"og:title\" content=\"New Relic Example in GoLang with Deep Instrumentation - Welcome To Golang By Example\" \/>\n<meta property=\"og:description\" content=\"It is easy to integrate newrelic in GoLang. We just need one of the middleware to use the newrelic. Application. For eg in GIN framework of GO we can do something like...\" \/>\n<meta property=\"og:url\" content=\"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/\" \/>\n<meta property=\"og:site_name\" content=\"Welcome To Golang By Example\" \/>\n<meta property=\"article:published_time\" content=\"2019-08-09T10:51:50+00:00\" \/>\n<meta property=\"article:modified_time\" content=\"2019-11-12T20:06:32+00:00\" \/>\n<meta property=\"og:image\" content=\"https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?fit=980%2C545&amp;ssl=1\" \/>\n<meta name=\"author\" content=\"admin\" \/>\n<meta name=\"twitter:card\" content=\"summary_large_image\" \/>\n<meta name=\"twitter:label1\" content=\"Written by\" \/>\n\t<meta name=\"twitter:data1\" content=\"admin\" \/>\n\t<meta name=\"twitter:label2\" content=\"Est. reading time\" \/>\n\t<meta name=\"twitter:data2\" content=\"2 minutes\" \/>\n<script type=\"application\/ld+json\" class=\"yoast-schema-graph\">{\"@context\":\"https:\/\/schema.org\",\"@graph\":[{\"@type\":\"WebPage\",\"@id\":\"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/\",\"url\":\"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/\",\"name\":\"New Relic Example in GoLang with Deep Instrumentation - Welcome To Golang By Example\",\"isPartOf\":{\"@id\":\"https:\/\/golangbyexamples.com\/#website\"},\"primaryImageOfPage\":{\"@id\":\"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/#primaryimage\"},\"image\":{\"@id\":\"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/#primaryimage\"},\"thumbnailUrl\":\"https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?fit=980%2C545&amp;ssl=1\",\"datePublished\":\"2019-08-09T10:51:50+00:00\",\"dateModified\":\"2019-11-12T20:06:32+00:00\",\"author\":{\"@id\":\"https:\/\/golangbyexamples.com\/#\/schema\/person\/8833ea7638dafd763cb1db6c0ca4576f\"},\"breadcrumb\":{\"@id\":\"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/#breadcrumb\"},\"inLanguage\":\"en-US\",\"potentialAction\":[{\"@type\":\"ReadAction\",\"target\":[\"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/\"]}]},{\"@type\":\"ImageObject\",\"inLanguage\":\"en-US\",\"@id\":\"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/#primaryimage\",\"url\":\"https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?fit=980%2C545&amp;ssl=1\",\"contentUrl\":\"https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?fit=980%2C545&amp;ssl=1\"},{\"@type\":\"BreadcrumbList\",\"@id\":\"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/#breadcrumb\",\"itemListElement\":[{\"@type\":\"ListItem\",\"position\":1,\"name\":\"Home\",\"item\":\"https:\/\/golangbyexamples.com\/\"},{\"@type\":\"ListItem\",\"position\":2,\"name\":\"New Relic Example in GoLang with Deep Instrumentation\"}]},{\"@type\":\"WebSite\",\"@id\":\"https:\/\/golangbyexamples.com\/#website\",\"url\":\"https:\/\/golangbyexamples.com\/\",\"name\":\"Welcome To Golang By Example\",\"description\":\"\",\"potentialAction\":[{\"@type\":\"SearchAction\",\"target\":{\"@type\":\"EntryPoint\",\"urlTemplate\":\"https:\/\/golangbyexamples.com\/?s={search_term_string}\"},\"query-input\":\"required name=search_term_string\"}],\"inLanguage\":\"en-US\"},{\"@type\":\"Person\",\"@id\":\"https:\/\/golangbyexamples.com\/#\/schema\/person\/8833ea7638dafd763cb1db6c0ca4576f\",\"name\":\"admin\",\"image\":{\"@type\":\"ImageObject\",\"inLanguage\":\"en-US\",\"@id\":\"https:\/\/golangbyexamples.com\/#\/schema\/person\/image\/\",\"url\":\"https:\/\/secure.gravatar.com\/avatar\/?s=96&d=mm&r=g\",\"contentUrl\":\"https:\/\/secure.gravatar.com\/avatar\/?s=96&d=mm&r=g\",\"caption\":\"admin\"},\"url\":\"https:\/\/golangbyexamples.com\/author\/admin\/\"}]}<\/script>\n<!-- \/ Yoast SEO plugin. -->","yoast_head_json":{"title":"New Relic Example in GoLang with Deep Instrumentation - Welcome To Golang By Example","robots":{"index":"index","follow":"follow","max-snippet":"max-snippet:-1","max-image-preview":"max-image-preview:large","max-video-preview":"max-video-preview:-1"},"canonical":"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/","og_locale":"en_US","og_type":"article","og_title":"New Relic Example in GoLang with Deep Instrumentation - Welcome To Golang By Example","og_description":"It is easy to integrate newrelic in GoLang. We just need one of the middleware to use the newrelic. Application. For eg in GIN framework of GO we can do something like...","og_url":"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/","og_site_name":"Welcome To Golang By Example","article_published_time":"2019-08-09T10:51:50+00:00","article_modified_time":"2019-11-12T20:06:32+00:00","og_image":[{"url":"https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?fit=980%2C545&amp;ssl=1"}],"author":"admin","twitter_card":"summary_large_image","twitter_misc":{"Written by":"admin","Est. reading time":"2 minutes"},"schema":{"@context":"https:\/\/schema.org","@graph":[{"@type":"WebPage","@id":"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/","url":"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/","name":"New Relic Example in GoLang with Deep Instrumentation - Welcome To Golang By Example","isPartOf":{"@id":"https:\/\/golangbyexamples.com\/#website"},"primaryImageOfPage":{"@id":"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/#primaryimage"},"image":{"@id":"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/#primaryimage"},"thumbnailUrl":"https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?fit=980%2C545&amp;ssl=1","datePublished":"2019-08-09T10:51:50+00:00","dateModified":"2019-11-12T20:06:32+00:00","author":{"@id":"https:\/\/golangbyexamples.com\/#\/schema\/person\/8833ea7638dafd763cb1db6c0ca4576f"},"breadcrumb":{"@id":"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/#breadcrumb"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/"]}]},{"@type":"ImageObject","inLanguage":"en-US","@id":"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/#primaryimage","url":"https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?fit=980%2C545&amp;ssl=1","contentUrl":"https:\/\/i0.wp.com\/golangbyexamples.com\/wp-content\/uploads\/2019\/08\/Screen-Shot-2019-08-09-at-5.48.29-PM.png?fit=980%2C545&amp;ssl=1"},{"@type":"BreadcrumbList","@id":"https:\/\/golangbyexamples.com\/go-new-relic-example-in-golang-with-deep-instrumentation\/#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/golangbyexamples.com\/"},{"@type":"ListItem","position":2,"name":"New Relic Example in GoLang with Deep Instrumentation"}]},{"@type":"WebSite","@id":"https:\/\/golangbyexamples.com\/#website","url":"https:\/\/golangbyexamples.com\/","name":"Welcome To Golang By Example","description":"","potentialAction":[{"@type":"SearchAction","target":{"@type":"EntryPoint","urlTemplate":"https:\/\/golangbyexamples.com\/?s={search_term_string}"},"query-input":"required name=search_term_string"}],"inLanguage":"en-US"},{"@type":"Person","@id":"https:\/\/golangbyexamples.com\/#\/schema\/person\/8833ea7638dafd763cb1db6c0ca4576f","name":"admin","image":{"@type":"ImageObject","inLanguage":"en-US","@id":"https:\/\/golangbyexamples.com\/#\/schema\/person\/image\/","url":"https:\/\/secure.gravatar.com\/avatar\/?s=96&d=mm&r=g","contentUrl":"https:\/\/secure.gravatar.com\/avatar\/?s=96&d=mm&r=g","caption":"admin"},"url":"https:\/\/golangbyexamples.com\/author\/admin\/"}]}},"jetpack_featured_media_url":"","jetpack_publicize_connections":[],"jetpack_sharing_enabled":true,"jetpack_shortlink":"https:\/\/wp.me\/paOs1b-20","amp_validity":null,"amp_enabled":true,"_links":{"self":[{"href":"https:\/\/golangbyexamples.com\/wp-json\/wp\/v2\/posts\/124","targetHints":{"allow":["GET"]}}],"collection":[{"href":"https:\/\/golangbyexamples.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/golangbyexamples.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/golangbyexamples.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/golangbyexamples.com\/wp-json\/wp\/v2\/comments?post=124"}],"version-history":[{"count":10,"href":"https:\/\/golangbyexamples.com\/wp-json\/wp\/v2\/posts\/124\/revisions"}],"predecessor-version":[{"id":514,"href":"https:\/\/golangbyexamples.com\/wp-json\/wp\/v2\/posts\/124\/revisions\/514"}],"wp:attachment":[{"href":"https:\/\/golangbyexamples.com\/wp-json\/wp\/v2\/media?parent=124"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/golangbyexamples.com\/wp-json\/wp\/v2\/categories?post=124"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/golangbyexamples.com\/wp-json\/wp\/v2\/tags?post=124"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}